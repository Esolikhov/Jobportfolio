# ПОЛНАЯ СИСТЕМА ЭЛЕКТРОННОЙ ОЧЕРЕДИ ДЛЯ СТОМАТОЛОГИЧЕСКОЙ КЛИНИКИ
# Dental clinic - сайт записи + электронная очередь

## 1) Коротко о проекте

Проект состоит из трех частей, которые работают вместе:

- фронт (сайт записи) - пациент выбирает врача, дату и время, оставляет имя и телефон
- сервер (API) - принимает заявки с сайта, отдает данные программе очереди, управляет статусами и проверяет занятость времени
- программа очереди (Windows-приложение) - администратор видит записи на день, формирует очередь к врачам, вызывает пациентов и показывает очередь на отдельном экране

Хостинг сделан на бесплатных тарифах (free tier) - сайт на Netlify, сервер на Koyeb, база данных в Supabase (PostgreSQL).

Важно: в репозитории есть код для SQLite (локальный режим), но в рабочем варианте проекта используется PostgreSQL (Supabase). SQLite оставлен только как запасной вариант для локального запуска.

## 2) Ссылки на развернутые сервисы

Все ссылки ниже оставлены как справочные:

Сайт (фронт):
- https://dental-service-web.netlify.app/

Сервер (API, Koyeb):
- https://spatial-jaime-dental-clinictj-7c05d6e5.koyeb.app/

Панель Koyeb (страница сервиса):
- https://app.koyeb.com/services/3f38bcf5-7e36-4a6a-b6b8-56a620a9e0da?deploymentId=ffba025b-930f-491c-aaec-01c825aa5209

База данных (Supabase):
- https://supabase.com/dashboard/project/wkultjmfhdcuwtuhghih/editor/17492?schema=public

Документы API:
https://spatial-jaime-dental-clinictj-7c05d6e5.koyeb.app/docs#/

## 3) Архитектура и роли компонентов

### Фронт (сайт записи)
- загружает список врачей из API
- загружает доступные слоты времени по выбранному врачу и дате
- отправляет запись на прием (создает запись в базе через API)
- после успешной записи показывает подтверждение пациенту

### Сервер (FastAPI)
- отдает врачей, расписание слотов и список записей
- запрещает записаться на уже занятое время
- добавляет запись в очередь к врачу по команде администратора
- управляет статусами очереди и проверяет статус врача
- включает CORS, поэтому сайт можно открывать из браузера без дополнительных настроек

### Программа очереди (desktop)
- показывает:
  - список врачей и их статусы
  - список записей на выбранную дату
  - текущую живую очередь (по врачам)
- позволяет:
  - создавать новую запись вручную
  - менять запись (врач, дата, время)
  - отменять запись через поиск по имени
  - добавлять запись в очередь к врачу
  - вызывать пациента (озвучка + статус на экране)
  - принимать пациента и завершать прием
- отдельный режим: 'Экран очереди' (окно для пациентов), которое можно вывести на второй монитор

## 4) Модель данных (PostgreSQL / Supabase)

В базе используются три основные таблицы.

### doctors
- id
- name
- specialization
- room
- is_active
- status

Типовые значения поля status:
- 'свободен'
- 'занят'
- 'выходной'
- 'перерыв'

### appointments
- id
- patient_name
- phone
- doctor_id
- appointment_date
- appointment_time
- created_at
- is_walk_in
- status
- service_name

Типовые значения status:
- 'активна'
- 'в_работе'
- 'завершена'
- 'отменена'
- 'не_пришёл'

### queue
- id
- appointment_id
- patient_name
- doctor_id
- room
- status
- called_at
- started_at
- finished_at

Типовые значения status:
- 'ожидание' - стоит в очереди
- 'готов' - приглашен (на экране пациента появляется 'ПРИГЛАШАЕМ')
- 'в_работе' - пациент принят (на экране 'ИДЕТ ПРИЕМ')
- 'завершен' - прием завершен

Связи:
- appointments.doctor_id -> doctors.id
- queue.doctor_id -> doctors.id
- queue.appointment_id -> appointments.id (если пациент пришел по записи)

## 5) Как работает программа очереди (логика кнопок)

### 5.1 Сначала запись должна попасть в очередь врача
1) Администратор выбирает запись в таблице 'Записи на прием'
2) Нажимает кнопку 'Пригласить' (в блоке записей)

Что происходит:
- программа проверяет статус врача
- если врач не 'свободен' (например, 'занят', 'выходной', 'перерыв') - запись не добавляется в очередь
- если врач 'свободен' - запись добавляется в очередь со статусом 'ожидание'

Идея простая: сначала запись попадает в очередь врача, и только после этого ее можно реально вызвать на экран пациента.

### 5.2 Затем пациента нужно вызвать (второй шаг)
1) Администратор выбирает пациента в таблице 'Текущая очередь'
2) Нажимает кнопку 'Пригласить' (в блоке очереди)

Что происходит:
- статус очереди меняется на 'готов'
- включается озвучка (если доступна)
- на экране пациента появляется надпись 'ПРИГЛАШАЕМ' и имя пациента в карточке врача

### 5.3 Принять пациента
1) В таблице 'Текущая очередь' выбирается пациент
2) Нажимается кнопка 'Принять'

Что происходит:
- статус меняется на 'в_работе'
- на экране пациента по этому врачу будет 'ИДЕТ ПРИЕМ' и имя

### 5.4 Завершить прием
1) В таблице 'Текущая очередь' выбирается пациент
2) Нажимается кнопка 'Завершить'

Что происходит:
- статус меняется на 'завершен'
- запись помечается как завершенная
- если у врача больше нет активных пациентов в очереди, врач становится 'свободен'

### 5.5 Изменить запись
- выбрать запись в таблице 'Записи на прием'
- нажать 'Изменить'
- поменять врача, дату или время
- сохранить

### 5.6 Отменить запись
1) Нажимается кнопка 'Отменить' (в блоке записей)
2) Открывается окно поиска по имени
3) Можно выбрать запись и нажать 'Отменить запись' или дважды щелкнуть по строке

Дальше:
- запись помечается как 'отменена'
- если запись уже была в очереди, она убирается из очереди

### 5.7 Удалить запись (через список)
Если нужно удалить запись вручную:
- найти запись в списке
- два раза щелкнуть по записи
- открыть расширенный режим (если есть)
- нажать кнопку 'Удалить'

Примечание: точное название кнопки зависит от экрана, но логика такая - удаление доступно из расширенного просмотра записи.

### 5.8 Дополнительно
- 'Новая запись' - создает запись вручную
- 'Статистика' - показывает сводку по записям
- 'Тема' - переключение темы интерфейса
- 'Экран очереди' - открывает окно для пациентов, которое обновляется автоматически

## 6) API (основные методы)

Сервер предоставляет следующие ключевые endpoints:

- GET /api/health - проверка, что сервер живой
- GET /api/doctors - список врачей
- GET /api/available-slots?doctor_id=&date= - слоты времени и признак доступности
- POST /api/appointments - создать запись
- GET /api/appointments/today?date= - записи на выбранную дату
- POST /api/queue - добавить запись в очередь
- GET /api/queue - текущая очередь (без завершенных)
- PUT /api/queue/{queue_id}/status - сменить статус очереди (готов, в_работе, завершен)
- PUT /api/doctors/{doctor_id}/status - сменить статус врача
- PUT /api/appointments/{apt_id}/cancel - отменить запись и убрать из очереди
- GET /api/stats - статистика

## 7) Sequence diagram (как данные проходят через все сервисы)

```mermaid
sequenceDiagram
  autonumber
  participant P as Patient
  participant W as Web site (Netlify)
  participant A as API (Koyeb)
  participant D as Postgres (Supabase)
  participant Q as Desktop app (Queue)
  participant S as Patient screen

  P->>W: Open booking page
  W->>A: GET /api/doctors
  A->>D: SELECT doctors
  D-->>A: doctors
  A-->>W: doctors list

  P->>W: Choose doctor and date
  W->>A: GET /api/available-slots?doctor_id&date
  A->>D: SELECT appointments for doctor/date (status='активна')
  D-->>A: booked times
  A-->>W: slots (time, available)

  P->>W: Submit booking
  W->>A: POST /api/appointments
  A->>D: INSERT appointments (status='активна')
  D-->>A: new id
  A-->>W: success

  Q->>A: GET /api/appointments/today?date
  A->>D: SELECT appointments by date
  D-->>A: appointments
  A-->>Q: appointments list

  Q->>A: POST /api/queue (add appointment to queue)
  A->>D: INSERT queue (status='ожидание'), UPDATE appointments status='в_работе'
  D-->>A: ok
  A-->>Q: success

  Q->>A: PUT /api/queue/{id}/status ('готов')
  A->>D: UPDATE queue status='готов'
  D-->>A: ok
  A-->>Q: ok

  S->>A: GET /api/queue (auto refresh)
  A->>D: SELECT active queue
  D-->>A: queue items
  A-->>S: show 'ПРИГЛАШАЕМ' for doctor

  Q->>A: PUT /api/queue/{id}/status ('в_работе')
  A->>D: UPDATE queue status='в_работе'
  D-->>A: ok
  A-->>Q: ok

  Q->>A: PUT /api/queue/{id}/status ('завершен')
  A->>D: UPDATE queue status='завершен', UPDATE appointments status='завершена'
  D-->>A: ok
  A-->>Q: ok

8) Переменные окружения
Сервер

DATABASE_URL - строка подключения к PostgreSQL (Supabase)

PGSSLMODE - обычно 'require' для Supabase

PORT - порт, который задает платформа (часто 8000)

Программа очереди

API_BASE - базовый URL API (если не задан, используется URL Koyeb)

9) Локальный запуск (если нужно)
Сервер
pip install -r requirements.txt
python server.py

Примечание:

без DATABASE_URL сервер может перейти на SQLite (локальный режим)

для рабочего режима используется PostgreSQL (Supabase)
Программа очереди
pip install -r requirements.txt
pip install requests
python queue_program.py

10) Экономическая эффективность (практический смысл)

Система закрывает задачи записи и очереди без платных CRM и без дорогой инфраструктуры:

сайт записи работает как простой канал для пациентов

администратор видит все записи на день и формирует очередь в два шага: сначала добавить в очередь, потом вызвать

статусы врачей исключают ситуацию, когда пациента добавляют к врачу, который не принимает

есть экран для пациентов, который показывает очередь в реальном времени

размещение на бесплатных тарифах дает нулевую стоимость при небольших нагрузках (надо учитывать лимиты free tier)

11) Что сознательно не используется

SQLite не является основной базой в рабочем проекте

SQLite-код и локальные функции оставлены как запасной вариант для автономного запуска и тестов
